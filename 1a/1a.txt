Дано: интернет магазин на "1с-битрикс: Бизнес", каталог, корзина и оформление заказа реализованы нативными компонентами (catalog, sale.basket.basker, sale.order.full). 
Задача:  реализовать акцию "Каждый N товар за X рублей". У акции должны быть настройки, где выставляется период активности акции, параметры N и X

Пример: при N=2 и X=1 каждый второй товар будет стоить 1 рубль. Выбираются товары с наименьшей ценой. Нужно считать каждый экземпляр товара. То есть если в корзине одного товара 5 штук, второго товара 3 штуки, то 4 товара надо продать за 1 рубль.

Еще один пример. В корзине:
товар 1, цена 500 рублей, 3 штуки
товар 2, цена 100 рублей, 2 штуки
товар 3, цена 200 рублей, 4 штуки
Акция: каждый 3-й товар за 1 рубль. У нас 9 предметов, значит 3 из них надо продать по рублю. Берем 3 самых дешевых предмета. Итого мы продаем товар 1 по своей цене, товар 2 продаем по рублю, у товара 3 продаем один предмет по рублю, три предмента по своей цене. Получилось 3 самых дешевых предмета по рублю, остальные по своей цене.


Решение:
Параметры задаются в .parameters.php в шаблонах компонентах корзины и оформления заказа.
Также в компоненты корзины и оформления заказа добавляю в result_modifier функцию, которой передаю массив элементов корзины, которая:
1. Проверяет период активности акции
2. Сортирует товары по цене по возрастанию
3. Циклом перебирет товары и для каждого товара перебирает каждую единицу, но ведет общий счетчик для каждой единицы.
	Если счетчик единицы кратен "N", то применяет к нему скидку выставляя стоимость "X".